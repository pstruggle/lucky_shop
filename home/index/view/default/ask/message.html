{include file="base/header" /}
<header>
    <a href="javascript:history.go(-1);" class="iconfont backIcon">&#60;</a>
    <h1>{$merchant.name}</h1>
</header>
<div style="height:1rem;"></div>
<div id="container">
    <div class="">
        <ul class="content">
            <!-- 欢迎加入qq群：454796847、135430763 -->
        </ul>
    </div>

    <div class="footer">
        <div id="user_face_icon">
            <img src="http://www.xttblog.com/icons/favicon.ico" alt="">
        </div>
        <input id="text" type="text" placeholder="说点什么吧...">
        <span id="btn">发送</span>
    </div>
</div>
</body>
</html>
<style>
    /**重置标签默认样式*/
    * {
        margin: 0;
        padding: 0;
        list-style: none;
        font-family: '微软雅黑'
    }
    body{
        height: 100%;
    }
    #container {
        width: 100%;
        height: calc(100% - 50px);
        background: #eee;
        margin: 0 auto;
        position: relative;
        box-shadow: 20px 20px 55px #777;
    }
    .header {
        background: #000;
        height: 40px;
        color: #fff;
        line-height: 34px;
        font-size: 20px;
        padding: 0 10px;
    }
    .footer {
        width: 100%;
        height: 50px;
        background: #666;
        position: absolute;
        bottom: 0;
        padding: 10px 0;
    }
    .footer input {
        width: calc(100% - 175px);
        height: 45px;
        outline: none;
        font-size: 20px;
        text-indent: 10px;
        position: absolute;
        border-radius: 6px;
        right: 80px;
    }
    .footer span {
        display: inline-block;
        width: 62px;
        height: 48px;
        background: #ccc;
        font-weight: 900;
        line-height: 45px;
        cursor: pointer;
        text-align: center;
        position: absolute;
        right: 10px;
        border-radius: 6px;
    }
    .footer span:hover {
        color: #fff;
        background: #999;
    }
    #user_face_icon {
        display: inline-block;
        background: red;
        width: 60px;
        height: 60px;
        border-radius: 30px;
        position: absolute;
        bottom: 6px;
        left: 14px;
        cursor: pointer;
        overflow: hidden;
    }
    img {
        width: 60px;
        height: 60px;
    }
    .content {
        font-size: 20px;
        /*width: 100%;*/
        height: 500px;
        overflow: auto;
        padding: 5px;
    }
    .content li {
        margin-top: 10px;
        padding-left: 10px;
        /*width: 412px;*/
        display: block;
        clear: both;
        overflow: hidden;
    }
    .content li img {
        float: left;
    }
    .content li span{
        background: #7cfc00;
        padding: 10px;
        border-radius: 10px;
        float: left;
        margin: 6px 10px 0 10px;
        max-width: 100%;
        border: 1px solid #ccc;
        box-shadow: 0 0 3px #ccc;
    }
    .content li img.imgleft {
        float: left;
    }
    .content li img.imgright {
        float: right;
    }
    .content li span.spanleft {
        float: left;
        background: #fff;
    }
    .content li span.spanright {
        float: right;
        background: #7cfc00;
    }
</style>

<script>
//    window.onload = function(){
//        var arrIcon = ['http://www.xttblog.com/icons/favicon.ico','http://www.xttblog.com/wp-content/uploads/2016/03/123.png'];
//        var num = 0;     //控制头像改变
//        var iNow = -1;    //用来累加改变左右浮动
//        var icon = document.getElementById('user_face_icon').getElementsByTagName('img');
//        var btn = document.getElementById('btn');
//        var text = document.getElementById('text');
//        var content = document.getElementsByTagName('ul')[0];
//        var img = content.getElementsByTagName('img');
//        var span = content.getElementsByTagName('span');
//
//        icon[0].onclick = function(){
//            if(num==0){
//                this.src = arrIcon[1];
//                num = 1;
//            }else if(num==1){
//                this.src = arrIcon[0];
//                num = 0;
//            }
//        }
//        btn.onclick = function(){
//            if(text.value ==''){
//                alert('不能发送空消息');
//            }else {
//                content.innerHTML += '<li><img src="'+arrIcon[num]+'"><span>'+text.value+'</span></li>';
//                iNow++;
//                if(num==0){
//                    img[iNow].className += 'imgright';
//                    span[iNow].className += 'spanright';
//                }else {
//                    img[iNow].className += 'imgleft';
//                    span[iNow].className += 'spanleft';
//                }
//                text.value = '';
//                // 内容过多时,将滚动条放置到最底端
//                content.scrollTop=content.scrollHeight;
//            }
//        }
//    }
    $(function(){
        var userinfo = eval('('+'{$user | json_encode}'+')');
        var merchant = eval('('+'{$merchant | json_encode}'+')');;
        var num = 0;     //控制头像改变
        var iNow = -1;    //用来累加改变左右浮动
        var icon = $('#user_face_icon img');
        var btn = $('#btn');
        var text = $('#text');
        var content = $('ul').eq(0);
        var img = content.find('img');
        var span = content.find('span');
        var ws = '';
        icon.attr('src',merchant.logo);
        btn.on('click',send_msg);
        // 发送消息
        function send_msg() {
            var msgs = text.val();
            var msg = {message:msgs,mid:merchant.id,uid:userinfo.id,direction:'1'};
            var t = JSON.stringify(msg);
            ws.send(t);
            if(msgs ==''){
                alert('不能发送空消息');
            }else {
                view_msg(msg);
            }
        }
        content.css('height',$('#container').height()-100 + 'px');
        // 消息初始化
        init_msg();
        function init_msg() {
            var datas = {uid:userinfo.id,mid:merchant.id};
            $.post("{:url('Ask/ajax_messages')}",datas,function (messages) {
                messages = eval('('+messages+')');
                for (var m in messages){
                    view_msg(messages[m]);
                }
            });
        }
        //链接socket
        socket_link();
        function socket_link() {
            ws = new WebSocket("ws://wenwen.xhmlxw.com:2346");
            ws.onopen = function() {
                var t = {uid:userinfo.id,direction:'1',open:true};
                t = JSON.stringify(t);
                ws.send(t);
            };
            ws.onmessage = function(e) {
                var msg = eval('('+e.data+')');
                if(msg.code && msg.code == '1'){
                    return false;
                }
                if(msg.mid != merchant.id){
                    //不是当前链接的用户
                    return ;
                }
                view_msg(msg);
            };
            ws.onclose = function(event) {
                if(event.code == 1006){
                    socket_link();
                }
            };
        }
        //消息视图
        function view_msg(message) {
            if(message.direction == '1'){
                content.append('<li><img src="'+userinfo.headimg+'"><span style="max-width: 200px">'+message.message+'</span></li>');
                iNow++;
                content.find('img').eq(iNow).addClass('imgright');
                content.find('span').eq(iNow).addClass('spanright');
                text.val('');
            }else if(message.direction == '2'){
                content.append('<li><img src="'+merchant.logo+'"><span style="max-width: 200px">'+message.message+'</span></li>');
                iNow++;
                content.find('img').eq(iNow).addClass('imgleft');
                content.find('span').eq(iNow).addClass('spanleft');
            }
            content.scrollTop(content[0].scrollHeight);
        }
    });
</script>
